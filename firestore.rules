rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Everybody can read activites, but only write if user
    match /activities/{activity} {
      allow read: if request.auth!=null;
      allow create: if request.resource.data.user == request.auth.uid;
      allow update: if resource.data.user == request.auth.uid;
    }
    // Only activity creator or like creator can read/write likes
    match /activities/{activity}/likes/{like} {
      allow read, write: if get(/databases/$(database)/documents/activities/$(activity)).data.user == request.auth.uid;
      allow read, write: if like == request.auth.uid;
    }
    // Can only create categories if status is REQUESTED
    // Can only read if status is active
    match /categories/{isoCountryCode}/categories/{category} {
      allow read: if request.auth != null
                    && resource.data.status == "ACTIVE";
      allow create: if request.auth != null
                    && request.resource.data.status == "REQUESTED";
    }
    // Can only create and read and update chat if user in users
    match /chats/{chat} {
      allow read: if request.auth.uid in resource.data.users;
      allow create: if request.auth.uid in request.resource.data.users;
      allow update: if request.auth.uid in resource.data.users;
    }
    // Messages can only be written by users, read by chat users
    match /chats/{chat}/messages/{message} {
      allow read: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chat)).data.users;
      allow read: if resource.data.user == request.auth.uid;
      allow create: if request.resource.data.user == request.auth.uid
                       && request.auth.uid in get(/databases/$(database)/documents/chats/$(chat)).data.users;
    }
    // Matches can be updated and read only
    match /matches/{matchId} {
      allow read, update: if resource.data.user == request.auth.uid;
    }
    // User data can only be written by user, read by anyone
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }
  }
}